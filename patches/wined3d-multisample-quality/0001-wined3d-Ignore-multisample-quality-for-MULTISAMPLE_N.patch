From 79a35fd2239cadfa9c8c588c295eef4ca9aba48a Mon Sep 17 00:00:00 2001
From: Paul Gofman <gofmanp@gmail.com>
Date: Tue, 22 Jan 2019 00:22:28 +0300
Subject: [PATCH] wined3d: Ignore multisample quality for MULTISAMPLE_NONE in
 context_find_fbo_entry().

Wine-bug: https://bugs.winehq.org/show_bug.cgi?id=39080
Signed-off-by: Paul Gofman <gofmanp@gmail.com>
---
 dlls/d3d9/tests/visual.c | 2 +-
 dlls/wined3d/context.c   | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/dlls/d3d9/tests/visual.c b/dlls/d3d9/tests/visual.c
index 072c6a8364..fb1c7ef21d 100644
--- a/dlls/d3d9/tests/visual.c
+++ b/dlls/d3d9/tests/visual.c
@@ -21273,7 +21273,7 @@ static void test_depthbias(void)
         }
 
         hr = IDirect3DDevice9_CreateDepthStencilSurface(device, 640, 480, formats[i],
-                D3DMULTISAMPLE_NONE, 0, FALSE, &ds, NULL);
+                D3DMULTISAMPLE_NONE, 1, FALSE, &ds, NULL);
         ok(SUCCEEDED(hr), "Failed to create depth stencil surface, hr %#x.\n", hr);
         hr = IDirect3DDevice9_SetDepthStencilSurface(device, ds);
         ok(SUCCEEDED(hr), "Failed to set depth stencil surface, hr %#x.\n", hr);
diff --git a/dlls/wined3d/context.c b/dlls/wined3d/context.c
index 37203738fe..c7eb7849fc 100644
--- a/dlls/wined3d/context.c
+++ b/dlls/wined3d/context.c
@@ -599,7 +599,8 @@ static struct fbo_entry *context_find_fbo_entry(struct wined3d_context *context,
             depth_stencil = &ds_null;
         }
         else if (ds_texture->resource.multisample_type != rt_texture->resource.multisample_type
-                || ds_texture->resource.multisample_quality != rt_texture->resource.multisample_quality)
+                || (ds_texture->resource.multisample_type
+                && ds_texture->resource.multisample_quality != rt_texture->resource.multisample_quality))
         {
             WARN("Color multisample type %u and quality %u, depth stencil has %u and %u, disabling ds buffer.\n",
                     rt_texture->resource.multisample_type, rt_texture->resource.multisample_quality,
-- 
2.20.1

