From ef3957d5000837c27a9623768b2f90df8b80b465 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Wed, 21 Dec 2016 00:54:37 +0100
Subject: [PATCH] winhttp: Fix handling of Accept headers.

---
 dlls/winhttp/request.c         |  9 ++-------
 dlls/winhttp/session.c         | 26 +++-----------------------
 dlls/winhttp/winhttp_private.h |  4 ++--
 3 files changed, 7 insertions(+), 32 deletions(-)

diff --git a/dlls/winhttp/request.c b/dlls/winhttp/request.c
index 27628c3..54f7214 100644
--- a/dlls/winhttp/request.c
+++ b/dlls/winhttp/request.c
@@ -398,7 +398,7 @@ static BOOL delete_header( struct request *request, DWORD index )
     return TRUE;
 }
 
-static BOOL process_header( struct request *request, const WCHAR *field, const WCHAR *value, DWORD flags,
+BOOL process_header( struct request *request, const WCHAR *field, const WCHAR *value, DWORD flags,
                             BOOL request_only )
 {
     int index;
@@ -2181,16 +2181,11 @@ static BOOL send_request( struct request *request, const WCHAR *headers, DWORD h
     struct session *session = connect->session;
     char *wire_req;
     int bytes_sent;
-    DWORD len, i, flags;
+    DWORD len;
 
     clear_response_headers( request );
     drain_content( request );
 
-    flags = WINHTTP_ADDREQ_FLAG_ADD|WINHTTP_ADDREQ_FLAG_COALESCE_WITH_COMMA;
-    for (i = 0; i < request->num_accept_types; i++)
-    {
-        process_header( request, attr_accept, request->accept_types[i], flags, TRUE );
-    }
     if (session->agent)
         process_header( request, attr_user_agent, session->agent, WINHTTP_ADDREQ_FLAG_ADD_IF_NEW, TRUE );
 
diff --git a/dlls/winhttp/session.c b/dlls/winhttp/session.c
index 2051d42..d528659 100644
--- a/dlls/winhttp/session.c
+++ b/dlls/winhttp/session.c
@@ -629,8 +629,6 @@ static void request_destroy( struct object_header *hdr )
         heap_free( request->headers[i].value );
     }
     heap_free( request->headers );
-    for (i = 0; i < request->num_accept_types; i++) heap_free( request->accept_types[i] );
-    heap_free( request->accept_types );
     for (i = 0; i < TARGET_MAX; i++)
     {
         for (j = 0; j < SCHEME_MAX; j++)
@@ -1047,32 +1045,14 @@ static const struct object_vtbl request_vtbl =
 
 static BOOL store_accept_types( struct request *request, const WCHAR **accept_types )
 {
+    static const WCHAR attr_accept[] = {'A','c','c','e','p','t',0};
+    static const DWORD flags = WINHTTP_ADDREQ_FLAG_ADD | WINHTTP_ADDREQ_FLAG_COALESCE_WITH_COMMA;
     const WCHAR **types = accept_types;
-    DWORD i;
 
     if (!types) return TRUE;
     while (*types)
     {
-        request->num_accept_types++;
-        types++;
-    }
-    if (!request->num_accept_types) return TRUE;
-    if (!(request->accept_types = heap_alloc( request->num_accept_types * sizeof(WCHAR *))))
-    {
-        request->num_accept_types = 0;
-        return FALSE;
-    }
-    types = accept_types;
-    for (i = 0; i < request->num_accept_types; i++)
-    {
-        if (!(request->accept_types[i] = strdupW( *types )))
-        {
-            for ( ; i > 0; --i) heap_free( request->accept_types[i - 1] );
-            heap_free( request->accept_types );
-            request->accept_types = NULL;
-            request->num_accept_types = 0;
-            return FALSE;
-        }
+        process_header( request, attr_accept, *types, flags, TRUE );
         types++;
     }
     return TRUE;
diff --git a/dlls/winhttp/winhttp_private.h b/dlls/winhttp/winhttp_private.h
index 2ee868c..3ac7f4a 100644
--- a/dlls/winhttp/winhttp_private.h
+++ b/dlls/winhttp/winhttp_private.h
@@ -198,8 +198,6 @@ struct request
     char  read_buf[8192]; /* buffer for already read but not returned data */
     struct header *headers;
     DWORD num_headers;
-    WCHAR **accept_types;
-    DWORD num_accept_types;
     struct authinfo *authinfo;
     struct authinfo *proxy_authinfo;
     HANDLE task_wait;
@@ -290,6 +288,8 @@ void destroy_authinfo( struct authinfo * ) DECLSPEC_HIDDEN;
 
 void release_host( struct hostdata *host ) DECLSPEC_HIDDEN;
 
+BOOL process_header( struct request *request, LPCWSTR field, LPCWSTR value, DWORD flags, BOOL request_only ) DECLSPEC_HIDDEN;
+
 extern HRESULT WinHttpRequest_create( void ** ) DECLSPEC_HIDDEN;
 void release_typelib( void ) DECLSPEC_HIDDEN;
 
-- 
1.9.1

