From 0b6fc918564f580a9d62f14d76da83349075574f Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Fri, 4 Dec 2015 09:22:35 +1100
Subject: [PATCH] d3dx9_36: Support NULL terminated strings in
 ID3DXFont_DrawText

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/d3dx9_36/font.c       | 10 ++++++++--
 dlls/d3dx9_36/tests/core.c |  1 -
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/dlls/d3dx9_36/font.c b/dlls/d3dx9_36/font.c
index ad1eb2383e4..83fec560fc5 100644
--- a/dlls/d3dx9_36/font.c
+++ b/dlls/d3dx9_36/font.c
@@ -210,9 +210,12 @@ static INT WINAPI ID3DXFontImpl_DrawTextA(ID3DXFont *iface, ID3DXSprite *sprite,
     TRACE("iface %p, sprite %p, string %s, count %d, rect %s, format %#x, color 0x%08x\n",
             iface,  sprite, debugstr_a(string), count, wine_dbgstr_rect(rect), format, color);
 
-    if (!string || count <= 0)
+    if (!string || count == 0)
         return 0;
 
+    if (count < 0)
+       count = -1;
+
     countW = MultiByteToWideChar(CP_ACP, 0, string, count, NULL, 0);
     stringW = HeapAlloc(GetProcessHeap(), 0, countW * sizeof(WCHAR));
     if (stringW)
@@ -235,9 +238,12 @@ static INT WINAPI ID3DXFontImpl_DrawTextW(ID3DXFont *iface, ID3DXSprite *sprite,
     TRACE("iface %p, sprite %p, string %s, count %d, rect %s, format %#x, color 0x%08x\n",
             iface,  sprite, debugstr_w(string), count, wine_dbgstr_rect(rect), format, color);
 
-    if (!string || count <= 0)
+    if (!string || count == 0)
         return 0;
 
+    if (count < 0)
+       count = lstrlenW(string);
+
     /* Strip terminating NULL characters */
     while (count > 0 && !string[count-1])
         count--;
-- 
2.17.1

