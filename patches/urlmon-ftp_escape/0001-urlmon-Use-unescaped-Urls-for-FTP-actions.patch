From 8900fa2361ec0fc9b22fd071a1c5d8cd5b7ffdbf Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andr=C3=A9=20Hentschel?= <nerv@dawncrow.de>
Date: Tue, 29 Jan 2019 08:37:52 +1100
Subject: [PATCH] urlmon: Use unescaped Urls for FTP actions

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=26445
---
 dlls/urlmon/ftp.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/dlls/urlmon/ftp.c b/dlls/urlmon/ftp.c
index aef4a6c..b438d7c 100644
--- a/dlls/urlmon/ftp.c
+++ b/dlls/urlmon/ftp.c
@@ -66,17 +66,23 @@ static HRESULT FtpProtocol_open_request(Protocol *prot, IUri *uri, DWORD request
         HINTERNET internet_session, IInternetBindInfo *bind_info)
 {
     FtpProtocol *This = impl_from_Protocol(prot);
-    BSTR url;
+    DWORD path_size = INTERNET_MAX_URL_LENGTH;
+    BSTR url, path;
     HRESULT hres;
 
     hres = IUri_GetAbsoluteUri(uri, &url);
     if(FAILED(hres))
         return hres;
+    path = heap_alloc(path_size);
+    hres = UrlUnescapeW((LPWSTR)url, path, &path_size, 0);
+    if(FAILED(hres))
+        return hres;
+    SysFreeString(url);
 
-    This->base.request = InternetOpenUrlW(internet_session, url, NULL, 0,
+    This->base.request = InternetOpenUrlW(internet_session, path, NULL, 0,
             request_flags|INTERNET_FLAG_EXISTING_CONNECT|INTERNET_FLAG_PASSIVE,
             (DWORD_PTR)&This->base);
-    SysFreeString(url);
+    SysFreeString(path);
     if (!This->base.request && GetLastError() != ERROR_IO_PENDING) {
         WARN("InternetOpenUrl failed: %d\n", GetLastError());
         return INET_E_RESOURCE_NOT_FOUND;
-- 
1.9.1

