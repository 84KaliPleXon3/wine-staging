From 977a76e8ed97d3dee870738b6fecfd3bc515e270 Mon Sep 17 00:00:00 2001
From: Zebediah Figura <z.figura12@gmail.com>
Date: Tue, 29 Jan 2019 21:47:14 -0600
Subject: [PATCH 08/13] ntoskrnl.exe: Implement ExDeleteResourceLite().

Signed-off-by: Zebediah Figura <z.figura12@gmail.com>
---
 dlls/ntoskrnl.exe/ntoskrnl.c |  9 ---------
 dlls/ntoskrnl.exe/sync.c     | 12 ++++++++++++
 include/ddk/wdm.h            |  1 +
 3 files changed, 13 insertions(+), 9 deletions(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index 556b2ae8..3cae33c9 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -3038,15 +3038,6 @@ NTSTATUS WINAPI IoCsqInitialize(PIO_CSQ csq, PIO_CSQ_INSERT_IRP insert_irp, PIO_
     return STATUS_SUCCESS;
 }
 
-/***********************************************************************
- *           ExDeleteResourceLite  (NTOSKRNL.EXE.@)
- */
-NTSTATUS WINAPI ExDeleteResourceLite(PERESOURCE resource)
-{
-    FIXME("(%p): stub\n", resource);
-    return STATUS_NOT_IMPLEMENTED;
-}
-
 /***********************************************************************
  *           KeEnterCriticalRegion  (NTOSKRNL.EXE.@)
  */
diff --git a/dlls/ntoskrnl.exe/sync.c b/dlls/ntoskrnl.exe/sync.c
index 0553db7f..705ea2c7 100644
--- a/dlls/ntoskrnl.exe/sync.c
+++ b/dlls/ntoskrnl.exe/sync.c
@@ -688,6 +688,18 @@ NTSTATUS WINAPI ExInitializeResourceLite( ERESOURCE *resource )
     return STATUS_SUCCESS;
 }
 
+/***********************************************************************
+ *           ExDeleteResourceLite   (NTOSKRNL.EXE.@)
+ */
+NTSTATUS WINAPI ExDeleteResourceLite( ERESOURCE *resource )
+{
+    TRACE("resource %p.\n", resource);
+    heap_free(resource->OwnerTable);
+    heap_free(resource->ExclusiveWaiters);
+    heap_free(resource->SharedWaiters);
+    return STATUS_SUCCESS;
+}
+
 /* Find an existing entry in the shared owner list, or create a new one. */
 static OWNER_ENTRY *resource_get_shared_entry( ERESOURCE *resource, ERESOURCE_THREAD thread )
 {
diff --git a/include/ddk/wdm.h b/include/ddk/wdm.h
index e95458bf..69efdb7a 100644
--- a/include/ddk/wdm.h
+++ b/include/ddk/wdm.h
@@ -1521,6 +1521,7 @@ PVOID     WINAPI ExAllocatePoolWithQuota(POOL_TYPE,SIZE_T);
 PVOID     WINAPI ExAllocatePoolWithTag(POOL_TYPE,SIZE_T,ULONG);
 PVOID     WINAPI ExAllocatePoolWithQuotaTag(POOL_TYPE,SIZE_T,ULONG);
 void      WINAPI ExDeleteNPagedLookasideList(PNPAGED_LOOKASIDE_LIST);
+NTSTATUS  WINAPI ExDeleteResourceLite(ERESOURCE*);
 void      WINAPI ExFreePool(PVOID);
 void      WINAPI ExFreePoolWithTag(PVOID,ULONG);
 void      WINAPI ExInitializeNPagedLookasideList(PNPAGED_LOOKASIDE_LIST,PALLOCATE_FUNCTION,PFREE_FUNCTION,ULONG,SIZE_T,ULONG,USHORT);
-- 
2.20.1

